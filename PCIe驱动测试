PCIe设备的测试除了常规的驱动测试点外，还需关注PCIe本身的特性，如配置空间、MSI/MSI-X中断、DMA操作、电源管理等。
必要工具：
1）硬件工具： PCIe分析仪（用于深度排查硬件级问题，如TLP包错误），可编程电源（用于电源测试）。
2）软件工具：
   lspci / setpci：查看和配置PCIe设备空间的核心工具。
   dmesg：查看内核环缓冲区，获取驱动加载、中断、错误等内核信息。
   perf / ftrace：性能剖析和函数跟踪。
   hdparm / dd / fio：磁盘性能测试（适用于NVMe、SATA控制器等）。
   ethtool / iperf3：网络性能测试（适用于网卡）。
   powertop：电源管理监控。
   Linux Test Project (LTP)：进行压力和一些基础IO测试。
   专门的压力测试工具：如 stress-ng。
   自定义脚本：用于自动化测试。

测试分类
1、功能与基本正确性测试
目标： 确保驱动能正确识别设备，提供基本功能，并且与系统其他部分正常交互。
FUN-001	设备识别与驱动加载	
1. 插入设备。
2. 运行 lspci -vvv 确认设备被正确识别（Vendor ID, Device ID, Class Code）。
3. 检查 dmesg 是否有驱动加载成功的日志。
4. 检查 /sys/bus/pci/devices/... 和 /proc/devices 是否存在对应的设备节点。

FUN-002	资源配置正确性	
1. 使用 lspci -vvv 查看设备的BAR空间大小和地址是否合理分配。
2. 检查中断类型（INTx# / MSI / MSI-X）是否按预期分配（lspci 的 Capabilities 部分）。
3. 确保没有资源冲突（如IO地址、内存地址重叠）。

FUN-003	基本IO操作	
1. （对于存储设备）使用 dd 进行读写，校验数据完整性（diff 命令）。
2. （对于网卡）使用 ping 测试基本连通性。
3. （对于GPU）使用 glxinfo 等工具确认OpenGL/Vulkan可正常初始化。

FUN-004	设备特定功能验证	
运行设备厂商提供的专用测试程序或标准行业测试工具，验证所有高级功能。
例如，对NVMe盘运行 nvme-cli 测试所有Admin和IO命令集。
----------------------------------------------------------------------------
2. 中断测试
目标： 测试MSI/MSI-X和传统INTx中断的正确性和稳定性。
INT-001	中断分配与响应	
1. 在驱动加载时，强制内核参数（如 pci=nomsi）切换中断模式（INTx -> MSI -> MSI-X）。
2. 在各种模式下进行功能测试（FUN-003），设备应工作正常。
3. 查看 /proc/interrupts，在设备工作时，对应的中断计数应稳定增加。

INT-002	中断压力测试	
1. 制造极高的中断频率（例如，让网卡以小包模式运行 iperf3）。
2. 观察系统响应是否正常，有无丢中断（/proc/interrupts 计数增长是否平滑）、系统是否僵死。

INT-003	中断共享测试	
（如果设备支持INTx）将多个PCIe设备插在同一根总线上，迫使它们共享INTx中断。验证所有设备在共享中断下仍能正常工作。

-----------------------------------------------------------------------------
3. DMA测试
目标： 确保设备能正确地进行DMA操作，不会损坏内存或引发安全问题。
DMA-001	DMA数据一致性	
1. 进行大规模、长时间的数据传输测试（如大文件拷贝）。
2. 使用校验和（如 sha256sum）确保源数据和目标数据完全一致，无任何比特位错误。

DMA-002	DMA地址映射错误处理	
（需代码审查配合）理论上，驱动应检查传递给设备的DMA地址的有效性。此测试可能需结合错误注入。

DMA-003	IOMMU集成测试	
1. 在BIOS/UEFI和内核中启用IOMMU（如Intel VT-d / AMD-Vi）。
2. 运行DMA测试，设备应正常工作。
3. 使用dmesg 确认IOMMU正在为该设备提供保护（可能有相关日志）。
-----------------------------------------------------------------------------
4. 错误恢复与健壮性测试
目标： 注入错误，测试驱动和设备的恢复能力。
ERR-001	AER错误注入与恢复	
1. 使用PCIe分析仪或高级调试工具向系统注入可纠正和不可纠正的AER错误。
2. 对于可纠正错误（如Bad TLP），系统应记录错误（dmesg）但继续运行。
3. 对于不可纠正的非致命错误，预期驱动应能检测到并尝试重置/恢复设备，而不导致系统崩溃。

ERR-002	设备热插拔	
1. 在系统运行时，直接拔掉PCIe设备（如果主板支持热插拔）。
2. 检查 dmesg 是否有正确的设备移除日志，无内核Oops。
3. 重新插入设备，设备应能被重新识别并正常工作。

ERR-003	驱动模块加载/卸载	
1. 在设备工作时，反复执行 rmmod 和 modprobe。
2. 每次重新加载后，设备应能恢复正常功能，无资源泄漏（可通过 /proc/meminfo 等观察）。
-----------------------------------------------------------------------------
5. 性能测试
目标： 衡量驱动效率，发现瓶颈。
PER-001	吞吐量与带宽	使用行业标准工具测试最大性能：fio (存储)，iperf3 (网络)，gpustress (GPU)。结果应与设备规格和平台能力相符。
PER-002	延迟测试	使用 fio (报告clat) 测试存储读写延迟，使用 ping 测试网络延迟。延迟应在可接受范围内且稳定。
PER-003	CPU占用率	在最大吞吐量下，使用 top 或 perf 监控驱动和中断处理所占用的CPU时间。一个高效的驱动应在高吞吐量下保持较低的CPU占用。
-----------------------------------------------------------------------------
6. 电源管理测试
目标： 测试设备在不同电源状态下的行为和功耗。
PM-001	运行时电源管理	
1. 使用 powertop 观察设备在空闲时是否能自动进入低功耗状态（如PCIe L1, L2/L3 Ready）。
2. 当有IO请求时，设备应能迅速唤醒到L0状态，无性能损失或功能异常。
PM-002	系统级睡眠/唤醒	
1. 让系统进入S3（睡眠）和S4（休眠）状态。
2. 唤醒系统后，立即运行功能测试（FUN-003）。设备应能完好无损地恢复工作，所有功能正常。
PM-003	PCIe设备电源状态切换	
使用 setpci 工具手动改变设备的电源状态（D0-D3cold），验证设备在状态切换后是否能正常响应。
-----------------------------------------------------------------------------
7. 兼容性与压力测试
目标： 确保驱动在不同环境和长时间运行下的稳定性。
STR-001	长时间压力测试	使用 fio、iperf3 等工具，以最大负载连续运行设备24/48/72小时。监控系统是否出现内存泄漏、句柄泄漏、性能下降或挂死。
STR-002	多设备/多CPU并发	
1. 在系统中插入多块同型号设备。
2. 使用多进程/多线程工具对所有设备同时施加压力，测试驱动的并发处理能力。
COM-001	内核版本兼容性	在多个不同的内核版本（如最新的稳定版、LTS版）上编译并测试驱动，确保API变化未导致问题。
-----------------------------------------------------------------------------
